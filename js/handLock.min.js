!function(t){var s=function(t){this.color=t.color||"#67ad65",this.bgColor=t.bgColor||"#f0f0f2",this.element=t.element,this.info=this.element.previousElementSibling,this.message=1===this.element.firstChild.nodeType?this.element.firstChild:this.element.firstChild.nextSibling,this.circles=[],this.touchCircles=[],this.restCircles=[],this.touchFlag=!1,this.reDraw=!1,this.init()};s.prototype={init:function(){this.createCanvas(),this.createCircles(),this.initPassword(),this.createListener()},createCanvas:function(){var t=this.element.getBoundingClientRect().width,s=t<300?300:t,i=document.createElement("canvas");i.width=i.height=s,this.element.appendChild(i);var e=i.cloneNode();e.style.cssText="position:absolute;top:0;left:0;z-index:-1;",this.element.appendChild(e),this.ctx1=i.getContext("2d"),this.canvas1=i,this.width=s,this.ctx2=e.getContext("2d"),this.canvas2=e},createCircles:function(){var t=3;this.r=3*this.width/(4+10*t);for(var s=0;s<t;s++)for(var i=0;i<t;i++){var e={x:10*i/3*this.r+7/3*this.r,y:10*s/3*this.r+7/3*this.r,id:3*s+i};this.circles.push(e),this.restCircles.push(e)}this.drawCircles()},initPassword:function(){this.setPassword=t.localStorage.getItem("HandLockPassword")?{model:3,text:t.localStorage.getItem("HandLockPassword").split("-")}:{model:1,text:[]},this.updateInfo()},updateInfo:function(){this.redInfo&&(this.redInfo=!1,this.info.style.color="#000"),1===this.setPassword.model?this.info.innerHTML="请设置手势密码":2===this.setPassword.model?this.info.innerHTML="再次输入以确认":3===this.setPassword.model&&(this.info.innerHTML="请输入手势密码")},createListener:function(){var t=this;this.canvas1.addEventListener("touchstart",function(s){var i=t.getTouchPosition(s);t.judgePos(i)},!1),this.canvas1.addEventListener("touchmove",this.throttle(function(t){var s=this.getTouchPosition(t);this.touchFlag?this.update(s):this.judgePos(s)},16,16),!1),this.canvas1.addEventListener("touchend",function(s){if(t.touchFlag){t.touchFlag=!1,t.checkPassword(),t.restCircles=t.restCircles.concat(t.touchCircles.splice(0));var i=setTimeout(function(){t.reset(),clearTimeout(i)},400)}},!1)},getTouchPosition:function(t){var s=t.target.getBoundingClientRect(),i={x:t.touches[0].clientX-s.left,y:t.touches[0].clientY-s.top};return i},update:function(t){this.drawLine2TouchPos(t),this.judgePos(t),this.reDraw&&(this.reDraw=!1,this.drawPoints(),this.drawLine())},judgePos:function(t){for(var s=0,i=this.restCircles.length;s<i;s++)if(Math.abs(t.x-this.restCircles[s].x)<this.r&&Math.abs(t.y-this.restCircles[s].y)<this.r){this.touchCircles.push(this.restCircles[s]),this.restCircles.splice(s,1),this.touchFlag=!0,this.reDraw=!0;break}},checkPassword:function(){var s=this.setPassword.model,i=this.setPassword.text,e=!0,h=this.touchCircles,o=function(){if(h.length===i.length)for(var t=0;t<h.length;t++)h[t].id!=i[t]&&(e=!1);else e=!1};if(1===s)if(h.length<5)this.showInfo("至少连接5个点，请重新绘制");else{for(var n=0;n<h.length;n++)i.push(h[n].id);this.setPassword.model=2,this.updateInfo()}else 2===s?(o(),e?(t.localStorage.setItem("HandLockPassword",i.join("-")),this.showMessage("手势密码设置成功",1e3),this.setPassword.model=3,this.updateInfo()):(this.showInfo("密码不一致，请重新设置"),this.setPassword.model=1,i.length=0)):3===s&&(o(),e?(this.showMessage("恭喜你，验证通过",1e3),t.location="http://www.jesse131.cn/blog/index.html"):this.showMessage("很遗憾，密码错误",1e3))},throttle:function(t,s,i){var e,h=new Date,o=this;return function(n){var r=new Date,c=arguments;n&&(n.preventDefault?n.preventDefault():null,n.stopPropagation?n.stopPropagation():null),clearTimeout(e),r-h>=i?(h=r,t.apply(o,c)):e=setTimeout(function(){t.apply(o,c)},s)}},drawCircles:function(){for(var t=0,s=this.circles.length;t<s;t++)this.drawCircle(this.circles[t].x,this.circles[t].y)},drawCircle:function(t,s,i){this.ctx1.strokeStyle=i||this.color,this.ctx1.fillStyle=this.bgColor,this.ctx1.lineWidth=1,this.ctx1.beginPath(),this.ctx1.arc(t,s,this.r,0,2*Math.PI,!0),this.ctx1.closePath(),this.ctx1.fill(),this.ctx1.stroke()},drawLine:function(){var t=this.touchCircles.length;if(t>=2){var s,i=this.touchCircles[t-2].x,e=this.touchCircles[t-1].x,h=this.touchCircles[t-2].y,o=this.touchCircles[t-1].y;s=h>=o?e>=i?Math.atan((h-o)/(e-i)):Math.PI+Math.atan((h-o)/(e-i)):e>=i?-Math.atan((o-h)/(e-i)):Math.PI-Math.atan((o-h)/(e-i));var n=i+this.r*Math.cos(s),r=h-this.r*Math.sin(s),c=e-this.r*Math.cos(s),a=o+this.r*Math.sin(s);this.ctx1.beginPath(),this.ctx1.lineWidth=3,this.ctx1.moveTo(n,r),this.ctx1.lineTo(c,a),this.ctx1.stroke(),this.ctx1.closePath()}},drawLine2TouchPos:function(t){var s=this.touchCircles.length;s>=1&&(this.ctx2.clearRect(0,0,this.width,this.width),this.ctx2.strokeStyle=this.color,this.ctx2.beginPath(),this.ctx2.lineWidth=3,this.ctx2.moveTo(this.touchCircles[s-1].x,this.touchCircles[s-1].y),this.ctx2.lineTo(t.x,t.y),this.ctx2.stroke(),this.ctx2.closePath())},drawPoints:function(){var t=this.touchCircles.length-1;t>=0&&(this.ctx1.fillStyle=this.color,this.ctx1.beginPath(),this.ctx1.arc(this.touchCircles[t].x,this.touchCircles[t].y,this.r/3,0,2*Math.PI,!0),this.ctx1.closePath(),this.ctx1.fill())},reset:function(){this.ctx2.clearRect(0,0,this.width,this.width),this.ctx1.clearRect(0,0,this.width,this.width),this.drawCircles()},showInfo:function(t){var s=this.info,i=0;this.redInfo=!0,s.style.color="#f00",s.innerHTML=t;var e=setInterval(function(){if(i--,s.style.left=i+"px",i===-10){clearInterval(e);var t=setInterval(function(){if(i+=2,s.style.left=i+"px",10===i){clearInterval(t);var e=setInterval(function(){i--,s.style.left=i+"px",0===i&&clearInterval(e)},10)}},14)}},10)},showMessage:function(t,s){clearTimeout(this.showMessage.timer);var i=this.message;i.innerHTML=t,i.style.display="block",this.showMessage.timer=setTimeout(function(){i.style.display="none"},s||1e3)}},t.handLock=s}(window);